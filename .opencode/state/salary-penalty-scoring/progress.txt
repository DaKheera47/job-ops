# Progress Log
PRD: salary-penalty-scoring
Started: 2026-02-02

## Codebase Patterns
- **3-tier override system**: Every setting has 3 fields: `effective` (resolved value), `default` (hardcoded fallback), `override` (nullable user/env override). Pattern seen in types.ts:474-558.
- **Boolean settings naming**: `someSetting`, `defaultSomeSetting`, `overrideSomeSetting` with types `boolean`, `boolean`, `boolean | null`
- **Number settings naming**: Same pattern but with `number`, `number`, `number | null`

---

## Task - types-1
- Added 6 new fields to AppSettings interface in orchestrator/src/shared/types.ts:555-563
  - penalizeMissingSalary, defaultPenalizeMissingSalary, overridePenalizeMissingSalary (boolean types)
  - missingSalaryPenalty, defaultMissingSalaryPenalty, overrideMissingSalaryPenalty (number types)
- Updated test mock in orchestrator/src/client/pages/SettingsPage.test.tsx:124-133 to include new fields
- Files changed: 
  - orchestrator/src/shared/types.ts
  - orchestrator/src/client/pages/SettingsPage.test.tsx
- **Learnings:** When adding new required fields to AppSettings interface, must also update all test mocks that create mock AppSettings objects. TypeScript compilation will catch missing fields in tests.

## Task - schema-1
- Added Zod validation schema for salary penalty settings in orchestrator/src/shared/settings-schema.ts:78-79
  - penalizeMissingSalary: z.boolean().nullable().optional()
  - missingSalaryPenalty: z.number().int().min(0).max(100).nullable().optional()
- Verified schema validation:
  - Rejects penalty values < 0 (error: "Number must be greater than or equal to 0")
  - Rejects penalty values > 100 (error: "Number must be less than or equal to 100")
  - Accepts null for both fields
  - Accepts valid values within range (0-100)
- Files changed:
  - orchestrator/src/shared/settings-schema.ts
- **Learnings:** Zod schema fields follow pattern of `.nullable().optional()` to support 3-tier override system where null means "use default". Integer validation automatically applied with `.int()` chained before `.min()` and `.max()`.

## Task - backend-settings-1
- Implemented backend settings service for salary penalty in orchestrator/src/server/services/settings.ts:214-244
  - Added defaults: defaultPenalizeMissingSalary: false, defaultMissingSalaryPenalty: 10
  - Implemented 3-tier override logic (default -> env -> database) for penalizeMissingSalary (boolean)
  - Implemented 3-tier override logic for missingSalaryPenalty (number, clamped 0-100)
  - Added all 6 fields to return statement: effective, default, and override for both settings
- Updated SettingKey type in orchestrator/src/server/repositories/settings.ts:10-45 to include penalizeMissingSalary and missingSalaryPenalty
- Updated PATCH /api/settings handler in orchestrator/src/server/api/routes/settings.ts:363-383 to accept both new fields
  - penalizeMissingSalary stored as "1"/"0"/null (boolean serialization)
  - missingSalaryPenalty stored as string number/null
- Files changed:
  - orchestrator/src/server/services/settings.ts
  - orchestrator/src/server/repositories/settings.ts
  - orchestrator/src/server/api/routes/settings.ts
- **Learnings:** Boolean settings stored in database as "1"/"0" strings and parsed with `=== "true" || === "1"`. Number settings stored as strings and parsed with `parseInt()` then clamped with `Math.min(max, Math.max(min, value))`. Database overrides take precedence over env vars (will be implemented in backend-settings-2).

