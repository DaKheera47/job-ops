# Progress Log
PRD: salary-penalty-scoring
Started: 2026-02-02

## Codebase Patterns
- **3-tier override system**: Every setting has 3 fields: `effective` (resolved value), `default` (hardcoded fallback), `override` (nullable user/env override). Pattern seen in types.ts:474-558.
- **Boolean settings naming**: `someSetting`, `defaultSomeSetting`, `overrideSomeSetting` with types `boolean`, `boolean`, `boolean | null`
- **Number settings naming**: Same pattern but with `number`, `number`, `number | null`

---

## Task - types-1
- Added 6 new fields to AppSettings interface in orchestrator/src/shared/types.ts:555-563
  - penalizeMissingSalary, defaultPenalizeMissingSalary, overridePenalizeMissingSalary (boolean types)
  - missingSalaryPenalty, defaultMissingSalaryPenalty, overrideMissingSalaryPenalty (number types)
- Updated test mock in orchestrator/src/client/pages/SettingsPage.test.tsx:124-133 to include new fields
- Files changed: 
  - orchestrator/src/shared/types.ts
  - orchestrator/src/client/pages/SettingsPage.test.tsx
- **Learnings:** When adding new required fields to AppSettings interface, must also update all test mocks that create mock AppSettings objects. TypeScript compilation will catch missing fields in tests.

## Task - schema-1
- Added Zod validation schema for salary penalty settings in orchestrator/src/shared/settings-schema.ts:78-79
  - penalizeMissingSalary: z.boolean().nullable().optional()
  - missingSalaryPenalty: z.number().int().min(0).max(100).nullable().optional()
- Verified schema validation:
  - Rejects penalty values < 0 (error: "Number must be greater than or equal to 0")
  - Rejects penalty values > 100 (error: "Number must be less than or equal to 100")
  - Accepts null for both fields
  - Accepts valid values within range (0-100)
- Files changed:
  - orchestrator/src/shared/settings-schema.ts
- **Learnings:** Zod schema fields follow pattern of `.nullable().optional()` to support 3-tier override system where null means "use default". Integer validation automatically applied with `.int()` chained before `.min()` and `.max()`.

## Task - backend-settings-1
- Implemented backend settings service for salary penalty in orchestrator/src/server/services/settings.ts:214-244
  - Added defaults: defaultPenalizeMissingSalary: false, defaultMissingSalaryPenalty: 10
  - Implemented 3-tier override logic (default -> env -> database) for penalizeMissingSalary (boolean)
  - Implemented 3-tier override logic for missingSalaryPenalty (number, clamped 0-100)
  - Added all 6 fields to return statement: effective, default, and override for both settings
- Updated SettingKey type in orchestrator/src/server/repositories/settings.ts:10-45 to include penalizeMissingSalary and missingSalaryPenalty
- Updated PATCH /api/settings handler in orchestrator/src/server/api/routes/settings.ts:363-383 to accept both new fields
  - penalizeMissingSalary stored as "1"/"0"/null (boolean serialization)
  - missingSalaryPenalty stored as string number/null
- Files changed:
  - orchestrator/src/server/services/settings.ts
  - orchestrator/src/server/repositories/settings.ts
  - orchestrator/src/server/api/routes/settings.ts
- **Learnings:** Boolean settings stored in database as "1"/"0" strings and parsed with `=== "true" || === "1"`. Number settings stored as strings and parsed with `parseInt()` then clamped with `Math.min(max, Math.max(min, value))`. Database overrides take precedence over env vars (will be implemented in backend-settings-2).

## Task - backend-settings-2
- Added penalizeMissingSalary to readableBooleanConfig in orchestrator/src/server/services/envSettings.ts:18
  - Entry includes settingKey, envKey (PENALIZE_MISSING_SALARY), defaultValue: false
- Updated settings.ts to read PENALIZE_MISSING_SALARY env var in orchestrator/src/server/services/settings.ts:217-223
  - defaultPenalizeMissingSalary now reads from process.env.PENALIZE_MISSING_SALARY (supports "1", "true", or "false"/"0")
  - Follows same pattern as other boolean env vars (jobspyIsRemote, jobspyLinkedinFetchDescription)
- Updated settings.ts to read MISSING_SALARY_PENALTY env var in orchestrator/src/server/services/settings.ts:226-233
  - defaultMissingSalaryPenalty now reads from process.env.MISSING_SALARY_PENALTY
  - Parses as integer, clamps to 0-100 range, falls back to 10 if invalid
- Files changed:
  - orchestrator/src/server/services/envSettings.ts
  - orchestrator/src/server/services/settings.ts
- **Learnings:** Boolean env vars support "1"/"true" (truthy) and "0"/"false" (falsy). When adding to readableBooleanConfig, applyStoredEnvOverrides() automatically handles applying database overrides to process.env. Number env vars parsed with parseInt() and clamped to valid range, with fallback to default value if NaN.

## Task - scoring-1
- Implemented salary penalty in LLM scoring path in orchestrator/src/server/services/scorer.ts:38-105
  - Added getSetting() calls to fetch penalizeMissingSalary and missingSalaryPenalty settings (lines 42-52)
  - Parse boolean setting from string: `penalizeMissingSalarySetting === "true" || === "1"` (lines 61-63)
  - Parse number setting with fallback: `parseInt(missingSalaryPenaltySetting, 10)` clamped 0-100, default 10 (lines 64-66)
  - After LLM returns score, check if penalty should be applied: `if (penalizeMissingSalary && !job.salary?.trim())` (line 101)
  - Subtract penalty and clamp to 0: `Math.max(0, finalScore - missingSalaryPenalty)` (line 102)
  - Final score still clamped to 0-100 range before return (line 107)
- Files changed:
  - orchestrator/src/server/services/scorer.ts
- **Learnings:** Settings fetched from database via getSetting() return string values that need parsing. Boolean settings stored as "true"/"1" for true, need explicit comparison. The `!job.salary?.trim()` pattern checks for null/undefined/empty/whitespace in one expression. Penalty applied after LLM scoring but before final return, only affects jobs with missing salary when enabled.

## Task - scoring-2
- Made mockScore() async and updated to apply salary penalty in orchestrator/src/server/services/scorer.ts:252-303
  - Changed function signature to accept penalizeMissingSalary (boolean) and missingSalaryPenalty (number) parameters
  - Changed return type to Promise<SuitabilityResult> to make it async
  - Added penalty logic after keyword scoring: `if (penalizeMissingSalary && !job.salary?.trim())` applies penalty (line 294)
  - Penalty is applied before final clamping: `score = Math.max(0, score - missingSalaryPenalty)` (line 295)
  - Final score still clamped to 0-100 range (line 298)
- Updated both mockScore() call sites in scoreJobSuitability() to await and pass penalty parameters (lines 86, 96)
- Files changed:
  - orchestrator/src/server/services/scorer.ts
- **Learnings:** When making a function async, must update all call sites to await. Rather than fetching settings inside mockScore(), passed them as parameters since they're already fetched in scoreJobSuitability(). This avoids redundant database queries and keeps mockScore() testable without database dependencies.

## Task - ui-component-1
- Created ScoringSettingsSection.tsx component in orchestrator/src/client/pages/settings/components/
  - Component renders AccordionItem with value='scoring'
  - Uses Calculator icon from lucide-react in trigger alongside "Scoring Settings" heading
  - Checkbox bound to penalizeMissingSalary field using react-hook-form Controller
  - Number input bound to missingSalaryPenalty field using SettingsInput component
  - Number input disabled when checkbox unchecked (using watch() to observe form state)
  - Input validation: min=0, max=100, placeholder shows default (10), onChange clamps values to range
  - Displays effective vs default values at bottom for both settings
  - Follows styling patterns from DisplaySettingsSection and BackupSettingsSection
- Added ScoringValues type to orchestrator/src/client/pages/settings/types.ts:52-55
  - Contains penalizeMissingSalary and missingSalaryPenalty, both as EffectiveDefault<T> types
- Files changed:
  - orchestrator/src/client/pages/settings/components/ScoringSettingsSection.tsx (new file)
  - orchestrator/src/client/pages/settings/types.ts
- **Learnings:** UI settings sections follow consistent pattern: AccordionItem wrapper, Controller for form binding, conditional rendering with watch() for dependent fields, SettingsInput for number inputs with validation/clamping, Separator before effective/default display. The watch() hook from react-hook-form enables conditional UI without lifting state.

## Task - ui-integration-1
- Integrated ScoringSettingsSection into SettingsPage in orchestrator/src/client/pages/SettingsPage.tsx
  - Added import for ScoringSettingsSection component (line 9)
  - Added penalizeMissingSalary: null and missingSalaryPenalty: null to DEFAULT_FORM_VALUES (lines 75-76)
  - Added penalizeMissingSalary: null and missingSalaryPenalty: null to NULL_SETTINGS_PAYLOAD (lines 117-118)
  - Updated mapSettingsToForm() to include penalizeMissingSalary and missingSalaryPenalty fields (lines 155-156)
  - Updated getDerivedSettings() to include scoring object with penalizeMissingSalary and missingSalaryPenalty effective/default values (lines 338-346)
  - Destructured scoring from derived settings (line 484)
  - Rendered ScoringSettingsSection in accordion between DisplaySettingsSection and EnvironmentSettingsSection (lines 851-855)
  - Updated onSave() payload to include penalizeMissingSalary and missingSalaryPenalty with nullIfSame() normalization (lines 694-701)
- Files changed:
  - orchestrator/src/client/pages/SettingsPage.tsx
- **Learnings:** When integrating new settings into SettingsPage, must update 7 key locations: import, DEFAULT_FORM_VALUES, NULL_SETTINGS_PAYLOAD, mapSettingsToForm(), getDerivedSettings(), destructuring, component rendering, and onSave() payload. The nullIfSame() function ensures only changed values are sent to backend (null means "use default"). All SettingsPage tests pass after integration.
## Task - ui-validation-1
- Added form validation for missingSalaryPenalty field in orchestrator/src/client/pages/settings/components/ScoringSettingsSection.tsx
  - Imported formState from useFormContext to access validation errors (line 30)
  - Passed errors.missingSalaryPenalty?.message to SettingsInput error prop (lines 109-111)
  - Modified onChange handler to parse integers without clamping, letting Zod validation handle range checks (lines 96-106)
  - Changed input value from displaying default to empty string when null, improving UX for validation errors (line 95)
- Zod schema validation already configured in orchestrator/src/shared/settings-schema.ts:79-85
  - Validates .int() for integer-only values
  - Validates .min(0) to reject negative values
  - Validates .max(100) to reject values over 100
  - Displays Zod error messages below input field when validation fails
- Save button already disabled via canSave = isDirty && isValid in SettingsPage.tsx (form mode: "onChange" triggers validation on every change)
- Error message styling handled by SettingsInput component (text-destructive class for red error text)
- Files changed:
  - orchestrator/src/client/pages/settings/components/ScoringSettingsSection.tsx
- **Learnings:** Form validation pattern: 1) Zod schema defines validation rules, 2) zodResolver in useForm enables automatic validation, 3) formState.errors provides error messages, 4) pass error prop to input component, 5) isValid automatically controls save button. Removing client-side clamping (Math.min/max) allows Zod validation to trigger proper error messages instead of silently fixing invalid input.

## Task - persistence-1
- Added comprehensive test coverage for salary penalty persistence in orchestrator/src/server/api/routes/settings.test.ts
  - Test "persists salary penalty settings and handles reset to defaults":
    - Verifies GET /api/settings returns both new fields with correct defaults (penalizeMissingSalary: false, missingSalaryPenalty: 10)
    - Verifies PATCH accepts both fields and updates them correctly
    - Verifies settings persist across multiple GET requests
    - Verifies reset to defaults by setting values to null
    - Confirms overrides are cleared (overridePenalizeMissingSalary: null, overrideMissingSalaryPenalty: null)
  - Test "validates salary penalty range constraints":
    - Rejects missingSalaryPenalty < 0 (returns 400)
    - Rejects missingSalaryPenalty > 100 (returns 400)
    - Accepts boundary values (0 and 100)
- Database storage format verified through existing implementation in orchestrator/src/server/api/routes/settings.ts:364-382
  - Boolean stored as "1" (true) or "0" (false) or null
  - Number stored as string representation or null
- All verification steps from PRD completed:
  - PATCH /api/settings accepts both fields ✓
  - GET /api/settings returns both fields ✓
  - Database storage format correct ✓
  - Reset to defaults works ✓
  - Settings persist across requests ✓
- Files changed:
  - orchestrator/src/server/api/routes/settings.test.ts
- **Learnings:** Test pattern for settings persistence: 1) GET initial defaults, 2) PATCH with new values, 3) GET to verify persistence, 4) PATCH with null to reset, 5) GET to verify reset. All settings tests use test-utils.js helpers (startServer/stopServer) to create isolated database instances. Tests run sequentially (describe.sequential) to avoid database conflicts.
