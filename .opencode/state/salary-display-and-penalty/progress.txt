# Progress Log
PRD: salary-display-and-penalty
Started: 2026-02-04

## Codebase Patterns

**Settings System Three-Tier Pattern:**
- Default: from env vars or hardcoded defaults (settings-conversion.ts)
- Override: from database (settings.ts via repositories/settings.ts)
- Effective: resolved value using resolve function (default || override)

**Adding New Settings:**
1. Add to SettingKey union type in repositories/settings.ts
2. Add to SettingsConversionValueMap in settings-conversion.ts
3. Add metadata (defaultValue, parseOverride, serialize, resolve) to settingsConversionMetadata
4. Add to AppSettings interface in shared/src/types.ts (with default/override variants)
5. Add to updateSettingsSchema in shared/src/settings-schema.ts
6. Add resolution logic in services/settings.ts getEffectiveSettings()

**Testing Pattern:**
- Unit tests in settings-conversion.test.ts for serialization/deserialization
- Integration tests in api/routes/settings.test.ts for API endpoints

**Penalty Application Pattern:**
- Helper function checks if salary is missing (null/empty/whitespace)
- Applies penalty after score calculation but before return
- Clamps final score to minimum 0
- Appends penalty explanation to reason text
- Logs with INFO level including all relevant context (jobId, originalScore, penalty, finalScore)

---

## Task - backend-settings-1 & backend-settings-2
- Added penalizeMissingSalary (boolean) and missingSalaryPenalty (number 0-100) settings
- Implemented full three-tier pattern with env var support (PENALIZE_MISSING_SALARY, MISSING_SALARY_PENALTY)
- Added Zod validation with proper clamping for penalty values
- Files changed:
  - shared/src/types.ts:574-580 - Added AppSettings fields with default/override variants
  - shared/src/settings-schema.ts:78-85 - Added Zod validation
  - orchestrator/src/server/repositories/settings.ts:44-45 - Added SettingKey types
  - orchestrator/src/server/services/settings-conversion.ts:23-24,198-221 - Added metadata
  - orchestrator/src/server/services/settings.ts:208-225,294-299 - Added resolution logic
  - orchestrator/src/server/services/settings-conversion.test.ts - Added comprehensive tests
  - orchestrator/src/server/api/routes/settings.test.ts - Added integration tests
- **Learnings:** 
  - Settings system is well-structured with clear separation of concerns
  - Clamping happens in parseOverride for env vars and in Zod schema for API updates
  - Tests verify round-trip serialization, validation, and persistence

## Task - scoring-penalty-1
- Implemented salary penalty in AI-based scoring path
- Added `isSalaryMissing()` helper to detect null/empty/whitespace salary
- Added `applySalaryPenalty()` helper to apply penalty conditionally
- Penalty applied after AI score but before returning result
- Files changed:
  - orchestrator/src/server/services/scorer.ts:9,16-75,129-140,318-339 - Added penalty logic
  - orchestrator/src/server/services/scorer.test.ts - Added comprehensive tests (11 test cases)
- **Learnings:**
  - Penalty logic is shared between AI scoring and mock scoring paths via helper function
  - Settings fetched once per scoring call using `getEffectiveSettings()`
  - Logging includes all context for debugging (jobId, originalScore, penalty, finalScore)
  - Tests cover all edge cases: null/empty/whitespace salary, disabled penalty, score clamping, different penalty amounts

## Task - scoring-penalty-2
- Mock scoring penalty implementation completed as part of scoring-penalty-1
- Mock scoring now uses same `applySalaryPenalty()` helper function
- Penalty applied consistently between AI and mock scoring paths
- Tests verify mock scoring applies penalty correctly when API key is missing
- **Learnings:**
  - By sharing the penalty logic via helper function, both paths behave identically
  - This reduces code duplication and ensures consistency
