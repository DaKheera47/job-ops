# Progress Log
PRD: salary-display-and-penalty
Started: 2026-02-04

## Codebase Patterns

**Settings System Three-Tier Pattern:**
- Default: from env vars or hardcoded defaults (settings-conversion.ts)
- Override: from database (settings.ts via repositories/settings.ts)
- Effective: resolved value using resolve function (default || override)

**Adding New Settings:**
1. Add to SettingKey union type in repositories/settings.ts
2. Add to SettingsConversionValueMap in settings-conversion.ts
3. Add metadata (defaultValue, parseOverride, serialize, resolve) to settingsConversionMetadata
4. Add to AppSettings interface in shared/src/types.ts (with default/override variants)
5. Add to updateSettingsSchema in shared/src/settings-schema.ts
6. Add resolution logic in services/settings.ts getEffectiveSettings()

**Testing Pattern:**
- Unit tests in settings-conversion.test.ts for serialization/deserialization
- Integration tests in api/routes/settings.test.ts for API endpoints

**Penalty Application Pattern:**
- Helper function checks if salary is missing (null/empty/whitespace)
- Applies penalty after score calculation but before return
- Clamps final score to minimum 0
- Appends penalty explanation to reason text
- Logs with INFO level including all relevant context (jobId, originalScore, penalty, finalScore)

---

## Task - backend-settings-1 & backend-settings-2
- Added penalizeMissingSalary (boolean) and missingSalaryPenalty (number 0-100) settings
- Implemented full three-tier pattern with env var support (PENALIZE_MISSING_SALARY, MISSING_SALARY_PENALTY)
- Added Zod validation with proper clamping for penalty values
- Files changed:
  - shared/src/types.ts:574-580 - Added AppSettings fields with default/override variants
  - shared/src/settings-schema.ts:78-85 - Added Zod validation
  - orchestrator/src/server/repositories/settings.ts:44-45 - Added SettingKey types
  - orchestrator/src/server/services/settings-conversion.ts:23-24,198-221 - Added metadata
  - orchestrator/src/server/services/settings.ts:208-225,294-299 - Added resolution logic
  - orchestrator/src/server/services/settings-conversion.test.ts - Added comprehensive tests
  - orchestrator/src/server/api/routes/settings.test.ts - Added integration tests
- **Learnings:** 
  - Settings system is well-structured with clear separation of concerns
  - Clamping happens in parseOverride for env vars and in Zod schema for API updates
  - Tests verify round-trip serialization, validation, and persistence

## Task - scoring-penalty-1
- Implemented salary penalty in AI-based scoring path
- Added `isSalaryMissing()` helper to detect null/empty/whitespace salary
- Added `applySalaryPenalty()` helper to apply penalty conditionally
- Penalty applied after AI score but before returning result
- Files changed:
  - orchestrator/src/server/services/scorer.ts:9,16-75,129-140,318-339 - Added penalty logic
  - orchestrator/src/server/services/scorer.test.ts - Added comprehensive tests (11 test cases)
- **Learnings:**
  - Penalty logic is shared between AI scoring and mock scoring paths via helper function
  - Settings fetched once per scoring call using `getEffectiveSettings()`
  - Logging includes all context for debugging (jobId, originalScore, penalty, finalScore)
  - Tests cover all edge cases: null/empty/whitespace salary, disabled penalty, score clamping, different penalty amounts

## Task - scoring-penalty-2
- Mock scoring penalty implementation completed as part of scoring-penalty-1
- Mock scoring now uses same `applySalaryPenalty()` helper function
- Penalty applied consistently between AI and mock scoring paths
- Tests verify mock scoring applies penalty correctly when API key is missing
- **Learnings:**
  - By sharing the penalty logic via helper function, both paths behave identically
  - This reduces code duplication and ensures consistency

## Task - frontend-display-1
- Added salary display to JobListPanel as third line below company/location
- Salary only appears when non-null, non-empty, and non-whitespace using `job.salary?.trim()` check
- Implemented with same styling as company/location line (text-xs, muted-foreground, mt-0.5)
- Uses `truncate` class for automatic ellipsis on long salary strings
- Files changed:
  - orchestrator/src/client/pages/orchestrator/JobListPanel.tsx:90-94 - Added conditional salary display
- **Learnings:**
  - Optional chaining (`?.`) combined with `.trim()` elegantly handles null/empty/whitespace checks
  - Biome lint suggested using optional chaining instead of `job.salary && job.salary.trim()`
  - Consistent styling (text-xs, muted-foreground) maintains visual hierarchy in job list
  - Frontend changes don't require backend changes when data already exists in Job type

## Task - frontend-settings-1
- Created ScoringSettingsSection component for penalty settings UI
- Added scoring settings to Settings page accordion (positioned after Display Settings)
- Checkbox for "Penalize Missing Salary" with clear description
- Conditional numeric input for penalty amount (0-100, defaults to 10)
- Displays effective and default values for both settings
- Files changed:
  - orchestrator/src/client/pages/settings/components/ScoringSettingsSection.tsx - New component (130 lines)
  - orchestrator/src/client/pages/settings/types.ts:51-56 - Added ScoringValues type
  - orchestrator/src/client/pages/SettingsPage.tsx - Integrated scoring settings throughout:
    - Line 11: Import ScoringSettingsSection
    - Lines 75-76: Added to DEFAULT_FORM_VALUES
    - Lines 120-121: Added to NULL_SETTINGS_PAYLOAD
    - Lines 159-160: Added to mapSettingsToForm
    - Lines 343-353: Added to getDerivedSettings (scoring)
    - Line 500: Added to derived destructuring
    - Lines 712-719: Added to onSave payload
    - Lines 877-882: Rendered ScoringSettingsSection in Accordion
- **Learnings:**
  - Frontend settings follow clear pattern: DisplaySettings (boolean-only) and BackupSettings (boolean + conditional inputs)
  - Used watch() to conditionally show/hide penalty input when checkbox is enabled
  - Form values use nullIfSame to only persist overrides that differ from defaults
  - Settings UI benefits from SettingsInput component for consistent number input styling

## Task - frontend-settings-2
- All functionality was already implemented in frontend-settings-1
- Verified all acceptance criteria:
  - ✅ Numeric input appears when checkbox enabled (line 73-105 in ScoringSettingsSection.tsx)
  - ✅ Input validation: min=0, max=100, step=1 (lines 85-87)
  - ✅ Defaults to 10 when enabled (line 88)
  - ✅ Clamping prevents invalid values (line 94: Math.min/max)
  - ✅ Current/default/override displayed (lines 100, 115-128)
  - ✅ Settings save via PATCH /api/settings (SettingsPage onSave)
  - ✅ Settings persist across reloads (handled by settings system)
  - ✅ Reset to default works (handleReset uses NULL_SETTINGS_PAYLOAD which includes scoring settings)
- Fixed modelSelection.test.ts to account for new `getAllSettings` call introduced by penalty feature:
  - orchestrator/src/server/services/modelSelection.test.ts:9,11,23 - Added getAllSettings to mock
- **Learnings:**
  - Sometimes tasks can be completed together - frontend-settings-1 naturally included all of frontend-settings-2
  - Test mocks need to be updated when adding new dependencies to existing functions
  - The penalty feature introduced a getEffectiveSettings() call in applySalaryPenalty, which calls getAllSettings

## Task - testing-1
- Added comprehensive edge case test for low score with penalty (score 5 - penalty 10 = 0)
- Verified all acceptance criteria are covered by tests:
  - ✅ Job with salary 'Competitive' NOT penalized (scorer.test.ts:407-426)
  - ✅ Penalty of 0 results in no score change (scorer.test.ts:493-512)
  - ✅ Penalty of 100 on score 50 = 0, not -50 (scorer.test.ts:472-491)
  - ✅ Penalty of 10 on score 5 = 0, not -5 (scorer.test.ts:493-513) - NEW TEST ADDED
  - ✅ Invalid penalty (150) returns 400 error (settings.test.ts:86-98)
  - ✅ Mock scoring applies penalty correctly (scorer.test.ts:538-561)
- Files changed:
  - orchestrator/src/server/services/scorer.test.ts:472-513 - Added explicit test for low score edge case
- All feedback loops passed:
  - ✅ Type checking: tsc --noEmit (passed)
  - ✅ Linting: biome check (passed)
  - ✅ Formatting: biome format (passed)
  - ✅ Tests: 44 tests passing in scorer.test.ts, 4 tests passing in settings.test.ts
- **Learnings:**
  - Comprehensive test coverage for edge cases prevents regressions
  - Testing score clamping behavior explicitly documents expected behavior
  - All acceptance criteria were already covered except one edge case
  - Pre-existing test failures in ApplicationsPerDayChart and backup tests are unrelated to penalty feature

